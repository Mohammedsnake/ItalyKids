<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OTP Verification - Italy Kids FC</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #0066b3;
      --secondary: #E4002B;
      --accent: #009246;
      --light: #f8f9fa;
      --dark: #212529;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .otp-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      overflow: hidden;
      max-width: 450px;
      width: 100%;
      animation: fadeIn 0.5s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .otp-header {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      text-align: center;
      padding: 25px 20px;
    }

    .otp-header h2 {
      font-weight: 700;
      margin-bottom: 5px;
    }

    .otp-body {
      padding: 30px;
    }

    .logo {
      width: 70px;
      height: 70px;
      background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
      border-radius: 50%;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.5rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }

    .btn-primary {
      background: var(--primary);
      border: none;
      padding: 12px;
      font-weight: 600;
      border-radius: 10px;
      transition: all 0.3s;
      position: relative;
    }

    .btn-primary:hover {
      background: var(--secondary);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .btn-primary:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-loading .btn-text {
      visibility: hidden;
      opacity: 0;
    }
    
    .btn-loading::after {
      content: "";
      position: absolute;
      width: 20px;
      height: 20px;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      margin: auto;
      border: 3px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: button-loading-spinner 1s ease infinite;
    }
    
    @keyframes button-loading-spinner {
      from { transform: rotate(0turn); }
      to { transform: rotate(1turn); }
    }

    .otp-inputs {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 25px;
    }

    .otp-input {
      width: 55px;
      height: 55px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      transition: all 0.3s;
    }

    .otp-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(0,102,179,0.25);
      outline: none;
    }

    .otp-input.error {
      border-color: var(--secondary);
      animation: shake 0.5s linear;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-5px); }
      40%, 80% { transform: translateX(5px); }
    }

    .resend-text {
      margin-top: 20px;
      text-align: center;
      color: #6c757d;
    }

    .resend-link {
      color: var(--primary);
      cursor: pointer;
      font-weight: 600;
      text-decoration: none;
    }

    .resend-link:hover {
      color: var(--secondary);
      text-decoration: underline;
    }

    .resend-link.disabled {
      color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .countdown {
      color: var(--secondary);
      font-weight: 600;
    }

    .alert {
      border-radius: 10px;
      border: none;
      text-align: center;
      padding: 15px;
    }

    .alert-success {
      background-color: rgba(0,146,70,0.15);
      color: #008a3c;
    }

    .alert-danger {
      background-color: rgba(228,0,43,0.15);
      color: #c1002a;
    }

    .user-info {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      text-align: center;
    }

    .user-info p {
      margin-bottom: 5px;
    }

    .user-name {
      font-weight: 700;
      color: var(--primary);
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .back-link {
      text-align: center;
      margin-top: 20px;
    }
    
    .back-link a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    
    .back-link a:hover {
      color: var(--secondary);
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="otp-container">
    <div class="otp-header">
      <div class="logo">IK</div>
      <h2>OTP Verification</h2>
      <p>Italy Kids Football Club</p>
    </div>

    <div class="otp-body">
      <div class="user-info" id="userInfo">
        <p>Verifying for: <span class="user-name" id="userIdentifier"></span></p>
        <p>Request ID: <span class="user-name" id="requestId"></span></p>
      </div>

      <p class="text-center">A 6-digit OTP has been sent to your registered phone number</p>

      <form id="otpForm">
        <div class="otp-inputs">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required autocomplete="one-time-code" inputmode="numeric" id="otp-1">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required id="otp-2">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required id="otp-3">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required id="otp-4">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required id="otp-5">
          <input type="text" class="otp-input" maxlength="1" pattern="[0-9]" required id="otp-6">
        </div>

        <button type="submit" class="btn btn-primary w-100 mb-3" id="verifyBtn">
          <span class="btn-text">Verify & Continue</span>
          <span class="btn-loading d-none">
            <span class="loading"></span> Verifying...
          </span>
        </button>
      </form>

      <div class="resend-text">
        Didn't receive the code? 
        <span class="countdown" id="countdown">01:00</span>
        <a class="resend-link d-none" id="resendLink">Resend OTP</a>
        <a class="resend-link disabled d-none" id="resendingLink">
          <span class="loading"></span> Resending...
        </a>
      </div>

      <div id="successMessage" class="alert alert-success mt-4 d-none">
        <i class="fas fa-check-circle me-2"></i>
        <span id="successText">Verification Successful! Redirecting...</span>
      </div>

      <div id="errorMessage" class="alert alert-danger mt-4 d-none">
        <i class="fas fa-times-circle me-2"></i>
        <span id="errorText">Incorrect OTP. Please try again.</span>
      </div>
      
      <div class="back-link">
        <a href="#" id="backButton"><i class="fas fa-arrow-left me-2"></i>Back to previous page</a>
      </div>
    </div>
  </div>

  <script>
    // ==============================
    // Constants
    // ==============================
    const AUTH_API = 'http://localhost:5000/api/auth';
    const REGISTER_API = 'http://localhost:5000/api';
    const OTP_LENGTH = 6;
    const RESEND_DELAY = 60; // seconds

    // DOM Elements
    const otpForm = document.getElementById('otpForm');
    const otpInputs = document.querySelectorAll('.otp-input');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const successText = document.getElementById('successText');
    const countdown = document.getElementById('countdown');
    const resendLink = document.getElementById('resendLink');
    const resendingLink = document.getElementById('resendingLink');
    const userInfo = document.getElementById('userInfo');
    const userIdentifierEl = document.getElementById('userIdentifier');
    const requestIdEl = document.getElementById('requestId');
    const verifyBtn = document.getElementById('verifyBtn');
    const btnText = verifyBtn.querySelector('.btn-text');
    const btnLoading = verifyBtn.querySelector('.btn-loading');
    const backButton = document.getElementById('backButton');

    // State
    let state = {
      otpContext: null,
      usernameOrPhone: null,
      joinRequestId: null,
      userId: null,
      timerInterval: null,
      timeLeft: RESEND_DELAY,
      isSubmitting: false,
      isResending: false,
      redirectTimer: null
    };

    // ==============================
    // Init
    // ==============================
    document.addEventListener('DOMContentLoaded', function () {
      loadUserData();
      setupEventListeners();
      startCountdown();
      
      // Focus on first OTP input
      setTimeout(() => otpInputs[0].focus(), 100);
    });

    // ==============================
    // Load Data from LocalStorage
    // ==============================
    function loadUserData() {
      // Check for OTP context to determine flow
      state.otpContext = localStorage.getItem("otpContext"); // "login" or "registration"
      state.usernameOrPhone = localStorage.getItem("usernameOrPhone");
      state.userId = localStorage.getItem("pendingUserId");
      state.joinRequestId = localStorage.getItem("joinRequestId");
      const phone = localStorage.getItem("phone");

      // Set back button behavior
      backButton.href = state.otpContext === "registration" ? "index.html#join" : "login.html";

      // Show info depending on flow
      if (state.otpContext === "registration") {
        if (!state.joinRequestId || !phone) {
          showError('No registration data found. Please register again.', true);
          return;
        }
        userIdentifierEl.textContent = phone;
        requestIdEl.textContent = state.joinRequestId;
      } else {
        // Default to login context
        if (!state.usernameOrPhone && !state.userId) {
          showError('No login data found. Please login first.', true);
          return;
        }
        userIdentifierEl.textContent = state.usernameOrPhone || "Your account";
        requestIdEl.textContent = state.userId || "N/A";
      }
    }

    // ==============================
    // Event Listeners
    // ==============================
    function setupEventListeners() {
      // OTP input navigation
      otpInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value;

          // Auto-tab to next input if a digit is entered
          if (value.length === 1 && index < otpInputs.length - 1) {
            otpInputs[index + 1].focus();
          }

          // Auto-submit if all digits are entered
          if (index === otpInputs.length - 1 && value.length === 1) {
            const allFilled = Array.from(otpInputs).every(i => i.value.length === 1);
            if (allFilled) {
              // Small delay to allow the last digit to be visible
              setTimeout(() => otpForm.dispatchEvent(new Event('submit')), 100);
            }
          }
        });

        input.addEventListener('keydown', (e) => {
          // Handle backspace to move to previous input
          if (e.key === 'Backspace' && input.value === '' && index > 0) {
            otpInputs[index - 1].focus();
          }
          
          // Allow only numbers
          if (e.key.length === 1 && !/^\d$/.test(e.key)) {
            e.preventDefault();
          }
        });

        input.addEventListener('paste', (e) => handlePaste(e));
      });

      // Form submission
      otpForm.addEventListener('submit', handleSubmit);
      
      // Resend OTP
      resendLink.addEventListener('click', handleResendOTP);
    }

    function handlePaste(e) {
      e.preventDefault();
      const pastedData = e.clipboardData.getData('text').replace(/\D/g, '');
      const digits = pastedData.split('').slice(0, 6);
      
      digits.forEach((digit, i) => {
        if (i < otpInputs.length) {
          otpInputs[i].value = digit;
        }
      });
      
      // Focus on the next empty input or submit if all are filled
      const nextEmptyIndex = digits.length;
      if (nextEmptyIndex < otpInputs.length) {
        otpInputs[nextEmptyIndex].focus();
      } else if (digits.length === 6) {
        otpForm.dispatchEvent(new Event('submit'));
      }
    }

    // ==============================
    // Handle Submit
    // ==============================
    async function handleSubmit(e) {
      e.preventDefault();
      if (state.isSubmitting) return;

      const enteredOTP = Array.from(otpInputs).map(i => i.value).join('');
      if (enteredOTP.length !== OTP_LENGTH) {
        showError('Please enter the complete 6-digit OTP');
        highlightErrorInputs();
        return;
      }

      setSubmittingState(true);

      try {
        let response, endpoint, requestBody;
        
        if (state.otpContext === "registration") {
          // Registration OTP verify
          endpoint = `${REGISTER_API}/verify-otp`;
          requestBody = {
            joinRequestId: state.joinRequestId,
            otp: enteredOTP
          };
        } else {
          // Login OTP verify
          endpoint = `${AUTH_API}/verify-login-otp`;
          requestBody = {
            userId: state.userId,
            otp: enteredOTP
          };
        }

        response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();
        
        if (!response.ok || data.success === false) {
          throw new Error(data.message || 'OTP verification failed');
        }

        showSuccess('Verification Successful! Redirecting...');

        // Set all required authentication values
        localStorage.setItem("isLoggedIn", "true");
        if (data.token) localStorage.setItem("authToken", data.token);
        if (data.userId) localStorage.setItem("userId", data.userId);
        if (data.role) localStorage.setItem("role", data.role);
        if (data.user) localStorage.setItem("userData", JSON.stringify(data.user));

        // Cleanup OTP-specific storage items
        localStorage.removeItem("otpContext");
        localStorage.removeItem("username");
        localStorage.removeItem("pendingUserId");
        localStorage.removeItem("joinRequestId");
        localStorage.removeItem("phone");

        // Redirect based on context
        setTimeout(() => {
          if (state.otpContext === "registration") {
            window.location.href = "registration-success.html";
          } else {
            const role = data.role || localStorage.getItem('userRole') || 'user';
            let redirectUrl = 'dashboard.html';
            if (role === 'admin') redirectUrl = 'admin-dashboard.html';
            else if (role === 'captain') redirectUrl = 'captain.html';
            else if (role === 'coach') redirectUrl = 'coach-dashboard.html';
            window.location.href = redirectUrl;
          }
        }, 2000);

      } catch (error) {
        console.error('OTP verification error:', error);
        showError(error.message || 'Incorrect OTP. Please try again.');
        highlightErrorInputs();
        otpInputs[0].focus();
      } finally {
        setSubmittingState(false);
      }
    }

    // ==============================
    // Resend OTP
    // ==============================
    async function handleResendOTP() {
      if (state.isResending) return;
      state.isResending = true;
      updateResendUI();

      try {
        let response, endpoint, requestBody;

        if (state.otpContext === "registration") {
          endpoint = `${REGISTER_API}/resend-otp`;
          requestBody = { joinRequestId: state.joinRequestId };
        } else {
          // Login OTP verify (captain or player)
          endpoint = `${AUTH_API}/resend-login-otp`;
          requestBody = { 
            userId: state.userId,             // <-- add this
            usernameOrPhone: state.usernameOrPhone 
          };
        }

        response = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();
        if (!response.ok || data.success === false) {
          throw new Error(data.message || 'Failed to resend OTP');
        }

        resetCountdown();
        showTemporaryMessage('New OTP sent to your phone.', 'success');
      } catch (error) {
        console.error('Resend OTP error:', error);
        showTemporaryMessage(error.message || 'Failed to resend OTP', 'error');
      } finally {
        state.isResending = false;
        updateResendUI();
      }
    }


    // ==============================
    // UI Helpers
    // ==============================
    function startCountdown() {
      clearInterval(state.timerInterval);
      state.timerInterval = setInterval(() => {
        state.timeLeft--;
        if (state.timeLeft <= 0) {
          clearInterval(state.timerInterval);
          countdown.classList.add('d-none');
          resendLink.classList.remove('d-none');
        } else {
          const minutes = Math.floor(state.timeLeft / 60);
          const seconds = state.timeLeft % 60;
          countdown.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
      }, 1000);
    }

    function resetCountdown() {
      clearInterval(state.timerInterval);
      state.timeLeft = RESEND_DELAY;
      countdown.textContent = '01:00';
      countdown.classList.remove('d-none');
      resendLink.classList.add('d-none');
      startCountdown();
    }

    function setSubmittingState(isSubmitting) {
      state.isSubmitting = isSubmitting;
      if (isSubmitting) {
        btnText.classList.add('d-none');
        btnLoading.classList.remove('d-none');
        verifyBtn.disabled = true;
      } else {
        btnText.classList.remove('d-none');
        btnLoading.classList.add('d-none');
        verifyBtn.disabled = false;
      }
    }

    function updateResendUI() {
      if (state.isResending) {
        resendLink.classList.add('d-none');
        resendingLink.classList.remove('d-none');
      } else {
        resendingLink.classList.add('d-none');
        if (state.timeLeft <= 0) {
          resendLink.classList.remove('d-none');
        }
      }
    }

    function showError(message, shouldRedirect = false) {
      errorText.textContent = message;
      errorMessage.classList.remove('d-none');
      successMessage.classList.add('d-none');
      
      if (shouldRedirect) {
        // Only set up redirect if explicitly requested
        state.redirectTimer = setTimeout(() => {
          window.location.href = state.otpContext === "registration" ? "index.html#join" : "login.html";
        }, 3000);
      }
    }

    function showSuccess(message) {
      successText.textContent = message;
      successMessage.classList.remove('d-none');
      errorMessage.classList.add('d-none');
    }

    function showTemporaryMessage(message, type = 'success') {
      const alert = document.createElement('div');
      alert.className = `alert alert-${type === 'success' ? 'success' : 'danger'} mt-3`;
      alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'times'}-circle me-2"></i>${message}`;
      otpForm.parentNode.insertBefore(alert, otpForm.nextSibling);
      setTimeout(() => alert.remove(), 3000);
    }

    function highlightErrorInputs() {
      otpInputs.forEach(input => {
        input.classList.add('error');
        setTimeout(() => input.classList.remove('error'), 500);
      });
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if (state.timerInterval) clearInterval(state.timerInterval);
      if (state.redirectTimer) clearTimeout(state.redirectTimer);
    });
  </script>
</body>
</html>